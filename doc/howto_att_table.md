<!-- gfm -->

# How To Generate Attenuation Tables

Ryan Berthold  
February 2022

## Intro

The electric reference signal generated by the E8257D is converted to an
optical signal and transmitted over fiber to the receiver cabin, where it is
converted back to an electric signal, attenuated by a programmable attenuator
(6-bit, 31.5 dB), and then sent to the Signal Test Source Reference assembly
for distribution to the receiver cartridges.

The Namakanui tuning routine uses a lookup table to set the proper value
for the photonics attenuator at the target LO frequency; the initial setting
may then be adjusted slightly to bring the PLL IF power level reading
into the `[-.8, -2.5]V` range.

Attenuator tables are generated using three engineering scripts,
located in the src/ directory.  These are covered in detail below.
- `att_pmeter.py`
- `att_table_pmeter.py`
- `att_table.py`

> **NOTE:**
>
> The attenuator tables are indexed by LO frequency, not by signal generator
> reference frequency.  This is technically incorrect since the reference
> frequency will change depending on whether the PLL is locking above or below
> the reference signal.  In practice we don't expect the signal level to
> change very much, but it is recommended to pick a side for the PLL and
> stick with it.
>
> A future update to this software should fix the attenuator tables
> so they use the signal generator reference frequency instead.


## `att_pmeter.py`

This script tests the attenuator/software using a power meter attached to the
attenuator output.  The reference signal is set to a desired frequency and
power level, and the attenuator is swept across its full range.  It was used
to check the order and sense of attenuator bits (from the ADAM-6050), but now
that those initial tests are complete it is no longer needed.

The script does not make any assumptions about where the power meter is
attached, so you must manually configure the switches as required before
running the script.  You must also edit `data/pmeter.ini` for the IP/port
of the power meter.

The script defaults to 20 GHz reference signal at the power level taken from
the current `photonics_dbm` table set in `data/reference.ini`, but these can
be overridden using command-line options.

Expected output: A (mostly) linear att-pow relation, with minimum power at
maximum attenuation.

Possible problems:
- Power jumps between attenuation levels and doesn't ramp smoothly.
  Indicates that ADAM-6050 outputs are in the wrong order.
- Max power at max attenuation.
  Indicates that the sense of ADAM-6050 outputs are inverted
  (that 0 is 1 and vice versa).


## `att_table_pmeter.py`

This script also uses a power meter attached to the attenuator output,
and adjusts the attenuator level while varying the reference signal frequency
in order to produce +12 dBm at the PLL input.  Output from this script
can be modified and used as a starting point for `att_table.py`, below,
or just used to verify that there is sufficient reference signal power across
the entire tuning band.

The script does not make any assumptions about where the power meter is
attached, so you must manually configure the switches as required before
running the script.  You must also edit `data/pmeter.ini` for the IP/port
of the power meter.

You can run this script several times, using the previous table as input,
in order to quickly create a high-resolution attenuation table --
but generally this is better left to the `att_table.py` script.


## `att_table.py`

This script tunes the receiver at a range of frequencies, adjusting attenuation
to produce a target PLL IF power -- by default in the `[-1.4, -1.6]V` range.
This is the script used to generate the final set of attenuation tables used
by the operational system.

It's a good idea to generate high-resolution tables for fast and reliable
tuning.  During normal operations, the tuning routine can adjust the power
as needed, but its range is limited.  It will reduce the power as much as
necessary, but can only increase the power by 3 dB.  This avoids runaway
power levels in case the receiver cannot tune for some other reason.  With
high-resolution tables, the receiver should rarely need to adjust power levels
away from the initial lookup values.

The tables are linearly interpolated and support variable resolution.
For instance, at JCMT the band 6 table has a resolution of 0.1 GHz. But above
an LO of 264.65 GHz the PLL IF power drops off rapidly, and in this region the
table resolution is 0.01 GHz.

The following example shows how the b6 attenuator table is created at JCMT.

> **IMPORTANT:**
>
> This script can reduce the attenuator to minimum levels, and thus
> increase reference signal power to maximum levels.  If the receiver
> cannot lock for whatever reason, it may be possible to damage the
> harmonic mixer at the PLL input.
> 
> Before starting you should make sure that it's possible to tune the
> receiver using the `namakanui_tune.py` script, which may require
> hand-editing the output from `att_table_pmeter.py`
> (convert from reference to LO GHz) to create an initial attenuation table.
>


```sh
# work in the source data/ directory to avoid extra cp steps
cd /jac_sw/itsroot/src/namakanui/data

# b6 5GHz sweep, starting from max attenuation (63 counts)
../src/att_table.py 6 220:265:5 63 |& tee -a b6_att_five.20220315.1200.txt

# edit photonics.ini, set "b6_att = b6_att_five.20220315.1200.txt"
vim photonics.ini

# b6 1GHz sweep, starting from 5GHz table + 6 counts (3dB lower power)
../src/att_table.py 6 220:265:1 ini+6 |& tee -a b6_att_one.20220315.1210.txt

# edit photonics.ini, set "b6_att = b6_att_one.20220315.1210.txt"
vim photonics.ini

# b6 0.2GHz sweep, starting from 1GHz table + 2 counts (1 dB lower power)
../src/att_table.py 6 220:265:0.2 ini+2 |& tee -a b6_att_ptwo.20220315.1220.txt

# edit photonics.ini, set "b6_att = b6_att_ptwo.20220315.1220.txt"
vim photonics.ini

# b6 0.1GHz sweep, starting from 0.2GHz table exactly
../src/att_table.py 6 220:265:0.1 ini+0 |& tee -a b6_att.20220315.1230.txt

# edit photonics.ini, set "b6_att = b6_att.20220315.1230.txt"
vim photonics.ini

# refine the highest frequencies where power drops rapidly,
# appending to current 0.1GHz table
../src/att_table.py 6 264.65:265:0.01 ini+0 |& tee -a b6_att.20220315.1230.txt

# edit table to remove unrefined (overlapping) 264.7, 264.8, 264.9, 265.0 rows
vim b6_att.20220315.1230.txt

# install final table and updated photonics.ini file
make
```
